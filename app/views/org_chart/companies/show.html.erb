<% content_for :title, @company.name %>

<div class="flex flex-col gap-6">
  <%# Header %>
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-3">
      <%= link_to org_chart_path, class: "text-gray-400 hover:text-gray-600" do %>
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
      <% end %>
      <div>
        <div class="flex items-center gap-2">
          <h1 class="text-2xl font-bold text-gray-900"><%= @company.name %></h1>
          <span class="text-xs px-2 py-0.5 rounded-full bg-blue-50 text-blue-700"><%= @company.company_type_label %></span>
          <% unless @company.active? %>
            <span class="text-xs px-2 py-0.5 rounded-full bg-gray-100 text-gray-500">비활성</span>
          <% end %>
        </div>
        <p class="text-sm text-gray-500 mt-0.5">
          <%= @company.country.flag_emoji %> <%= @company.country.name %>
          <% if @company.name_en.present? %>
            · <%= @company.name_en %>
          <% end %>
        </p>
      </div>
    </div>
    <% if current_user.manager? || current_user.admin? %>
      <div class="flex gap-2">
        <%= link_to new_org_chart_company_department_path(@company),
            class: "inline-flex items-center gap-1.5 px-3 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors" do %>
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          부서 추가
        <% end %>
        <%= link_to edit_org_chart_company_path(@company),
            class: "inline-flex items-center gap-1.5 px-3 py-2 border border-gray-200 text-gray-600 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors" do %>
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          수정
        <% end %>
      </div>
    <% end %>
  </div>

  <%# 법인 정보 카드 %>
  <div class="bg-white rounded-xl border border-gray-200 p-5">
    <h2 class="text-sm font-semibold text-gray-700 mb-4">법인 정보</h2>
    <dl class="grid grid-cols-2 gap-4 sm:grid-cols-4">
      <div>
        <dt class="text-xs text-gray-400">법인 유형</dt>
        <dd class="mt-1 text-sm font-medium text-gray-900"><%= @company.company_type_label %></dd>
      </div>
      <div>
        <dt class="text-xs text-gray-400">총 직원 수</dt>
        <dd class="mt-1 text-sm font-medium text-gray-900"><%= @company.employee_count %>명</dd>
      </div>
      <% if @company.registration_number.present? %>
        <div>
          <dt class="text-xs text-gray-400">등록번호</dt>
          <dd class="mt-1 text-sm font-medium text-gray-900"><%= @company.registration_number %></dd>
        </div>
      <% end %>
      <% if @company.address.present? %>
        <div>
          <dt class="text-xs text-gray-400">주소</dt>
          <dd class="mt-1 text-sm font-medium text-gray-900"><%= @company.address %></dd>
        </div>
      <% end %>
    </dl>
  </div>

  <%# 부서 목록 %>
  <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
    <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
      <h2 class="text-sm font-semibold text-gray-700">부서 목록 (<%= @departments.count %>)</h2>
    </div>

    <% if @departments.empty? %>
      <div class="p-8 text-center text-sm text-gray-400">
        등록된 부서가 없습니다.
        <% if current_user.manager? || current_user.admin? %>
          <%= link_to new_org_chart_company_department_path(@company), class: "ml-1 text-primary hover:underline" do %>부서 추가<% end %>
        <% end %>
      </div>
    <% else %>
      <div class="divide-y divide-gray-50">
        <% @departments.each do |dept| %>
          <div x-data="{ open: true }" class="hover:bg-gray-50 transition-colors">
            <div class="flex items-center justify-between px-5 py-3 cursor-pointer"
                 @click="open = !open">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-md bg-gray-100 flex items-center justify-center">
                  <svg class="w-4 h-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                </div>
                <div>
                  <span class="text-sm font-medium text-gray-800"><%= dept.name %></span>
                  <% if dept.code.present? %>
                    <span class="text-xs text-gray-400 ml-1">(<%= dept.code %>)</span>
                  <% end %>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <span class="text-xs text-gray-400"><%= dept.employee_count %>명</span>
                <% if current_user.manager? || current_user.admin? %>
                  <%= link_to edit_org_chart_company_department_path(@company, dept),
                      class: "text-xs text-gray-400 hover:text-primary px-1.5 py-0.5 rounded hover:bg-gray-100",
                      onclick: "event.stopPropagation()" do %>수정<% end %>
                <% end %>
                <svg :class="open ? 'rotate-180' : ''" class="w-3.5 h-3.5 text-gray-400 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
              </div>
            </div>

            <%# 직원 목록 %>
            <div x-show="open" class="bg-gray-50 px-5 py-3 pl-16">
              <% dept_employees = dept.employees.select(&:active?).sort_by(&:name) %>
              <% if dept_employees.empty? %>
                <p class="text-xs text-gray-400">배속된 직원이 없습니다.</p>
              <% else %>
                <div class="flex flex-wrap gap-2">
                  <% dept_employees.each do |emp| %>
                    <%= link_to employee_path(emp), class: "flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-200 rounded-lg hover:border-primary/50 hover:shadow-sm transition-all" do %>
                      <div class="w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center text-primary text-xs font-bold flex-shrink-0">
                        <%= emp.name.first.upcase %>
                      </div>
                      <div>
                        <p class="text-xs font-medium text-gray-900"><%= emp.name %></p>
                        <% if emp.job_title.present? %>
                          <p class="text-xs text-gray-400"><%= emp.job_title %></p>
                        <% end %>
                      </div>
                      <% if emp.active_visa %>
                        <span class="w-2 h-2 rounded-full flex-shrink-0 <%= emp.visa_expiring_soon? ? 'bg-red-400' : 'bg-green-400' %>"></span>
                      <% end %>
                    <% end %>
                  <% end %>
                </div>
              <% end %>

              <%# 하위 부서 %>
              <% sub_depts = dept.sub_departments.select(&:active?).sort_by { |d| [d.sort_order, d.name] } %>
              <% sub_depts.each do |sub| %>
                <div class="mt-3 pt-3 border-t border-gray-100">
                  <p class="text-xs font-medium text-gray-500 mb-2">└ <%= sub.name %> (<%= sub.employee_count %>명)</p>
                  <div class="flex flex-wrap gap-2">
                    <% sub.employees.active.by_name.each do |emp| %>
                      <%= link_to employee_path(emp), class: "flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-200 rounded-lg hover:border-primary/50 text-xs" do %>
                        <div class="w-5 h-5 rounded-full bg-primary/10 flex items-center justify-center text-primary text-xs font-bold"><%= emp.name.first.upcase %></div>
                        <%= emp.name %>
                      <% end %>
                    <% end %>
                  </div>
                </div>
              <% end %>

              <% if current_user.manager? || current_user.admin? %>
                <div class="mt-2 pt-2 border-t border-gray-100 flex gap-2">
                  <%= link_to new_org_chart_company_department_path(@company, parent_id: dept.id),
                      class: "text-xs text-gray-400 hover:text-primary" do %>+ 하위 부서<% end %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
