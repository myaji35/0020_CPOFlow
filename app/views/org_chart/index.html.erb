<% content_for :title, "조직도" %>

<div class="flex flex-col gap-6">
  <%# Header %>
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">조직도</h1>
      <p class="text-sm text-gray-500 mt-1">국가 · 법인 · 부서 · 직원 계층 구조</p>
    </div>
    <% if current_user.manager? || current_user.admin? %>
      <div class="flex gap-2">
        <%= link_to new_org_chart_company_path, class: "inline-flex items-center gap-1.5 px-3 py-2 bg-primary text-white text-sm font-medium rounded-lg hover:bg-primary/90 transition-colors" do %>
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          법인 추가
        <% end %>
        <% if current_user.admin? %>
          <%= link_to org_chart_countries_path, class: "inline-flex items-center gap-1.5 px-3 py-2 border border-gray-200 text-gray-600 text-sm font-medium rounded-lg hover:bg-gray-50 transition-colors" do %>
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
            국가 관리
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if @countries.empty? %>
    <%# 데이터 없음 %>
    <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
      <svg class="w-12 h-12 mx-auto text-gray-300 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      <p class="text-gray-500 text-sm">등록된 조직이 없습니다.</p>
      <% if current_user.admin? %>
        <%= link_to new_org_chart_country_path, class: "mt-3 inline-flex text-sm text-primary hover:underline" do %>
          국가 먼저 추가하기 →
        <% end %>
      <% end %>
    </div>
  <% else %>
    <%# 국가 탭 %>
    <div x-data="{ country: '<%= @selected_country_code %>' }">
      <div class="flex gap-1 bg-gray-100 rounded-lg p-1 w-fit">
        <% @countries.each do |c| %>
          <button
            @click="country = '<%= c.code %>'"
            :class="country === '<%= c.code %>' ? 'bg-white shadow text-gray-900' : 'text-gray-500 hover:text-gray-700'"
            class="px-4 py-1.5 rounded-md text-sm font-medium transition-all">
            <%= c.flag_emoji %> <%= c.name %>
          </button>
        <% end %>
      </div>

      <%# 각 국가별 법인 트리 %>
      <% @countries.each do |country| %>
        <div x-show="country === '<%= country.code %>'" class="mt-4 space-y-4">
          <% companies = country.companies.select(&:active?) %>
          <% if companies.empty? %>
            <div class="bg-white rounded-xl border border-dashed border-gray-200 p-8 text-center text-sm text-gray-400">
              이 국가에 등록된 법인이 없습니다.
              <% if current_user.manager? || current_user.admin? %>
                <%= link_to new_org_chart_company_path(country_id: country.id), class: "ml-2 text-primary hover:underline" do %>법인 추가<% end %>
              <% end %>
            </div>
          <% end %>

          <% companies.each do |company| %>
            <div x-data="{ open: true }" class="bg-white rounded-xl border border-gray-200 overflow-hidden">
              <%# 법인 헤더 %>
              <div class="flex items-center justify-between px-5 py-4 cursor-pointer hover:bg-gray-50 transition-colors"
                   @click="open = !open">
                <div class="flex items-center gap-3">
                  <div class="w-9 h-9 rounded-lg bg-primary/10 flex items-center justify-center">
                    <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
                  </div>
                  <div>
                    <div class="flex items-center gap-2">
                      <span class="font-semibold text-gray-900"><%= company.name %></span>
                      <span class="text-xs px-2 py-0.5 rounded-full bg-blue-50 text-blue-700"><%= company.company_type_label %></span>
                    </div>
                    <% if company.name_en.present? %>
                      <p class="text-xs text-gray-400"><%= company.name_en %></p>
                    <% end %>
                  </div>
                </div>
                <div class="flex items-center gap-3">
                  <span class="text-xs text-gray-500"><%= company.employee_count %>명</span>
                  <% if current_user.manager? || current_user.admin? %>
                    <%= link_to edit_org_chart_company_path(company),
                        class: "text-xs text-gray-400 hover:text-primary px-2 py-1 rounded hover:bg-gray-100",
                        onclick: "event.stopPropagation()" do %>수정<% end %>
                  <% end %>
                  <svg :class="open ? 'rotate-180' : ''" class="w-4 h-4 text-gray-400 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                </div>
              </div>

              <%# 부서 트리 %>
              <div x-show="open"  class="border-t border-gray-100">
                <% root_depts = company.departments.select { |d| d.active? && d.parent_id.nil? }.sort_by { |d| [d.sort_order, d.name] } %>
                <% if root_depts.empty? %>
                  <div class="px-5 py-4 text-sm text-gray-400 text-center">
                    등록된 부서가 없습니다.
                    <% if current_user.manager? || current_user.admin? %>
                      <%= link_to new_org_chart_company_department_path(company), class: "ml-1 text-primary hover:underline" do %>부서 추가<% end %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="divide-y divide-gray-50">
                    <% root_depts.each do |dept| %>
                      <div x-data="{ deptOpen: false }">
                        <%# 부서 행 %>
                        <div class="flex items-center justify-between px-5 py-3 hover:bg-gray-50 cursor-pointer"
                             @click="deptOpen = !deptOpen">
                          <div class="flex items-center gap-3 pl-4">
                            <div class="w-7 h-7 rounded-md bg-gray-100 flex items-center justify-center">
                              <svg class="w-4 h-4 text-gray-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                            </div>
                            <div>
                              <span class="text-sm font-medium text-gray-800"><%= dept.name %></span>
                              <% if dept.code.present? %>
                                <span class="text-xs text-gray-400 ml-1">(<%= dept.code %>)</span>
                              <% end %>
                            </div>
                          </div>
                          <div class="flex items-center gap-3">
                            <span class="text-xs text-gray-400"><%= dept.employee_count %>명</span>
                            <% if current_user.manager? || current_user.admin? %>
                              <%= link_to edit_org_chart_company_department_path(company, dept),
                                  class: "text-xs text-gray-400 hover:text-primary px-1.5 py-0.5 rounded hover:bg-gray-100",
                                  onclick: "event.stopPropagation()" do %>수정<% end %>
                            <% end %>
                            <svg :class="deptOpen ? 'rotate-180' : ''" class="w-3.5 h-3.5 text-gray-400 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                          </div>
                        </div>

                        <%# 직원 목록 %>
                        <div x-show="deptOpen"  class="bg-gray-50 px-5 py-3 pl-16">
                          <% dept_employees = dept.employees.select(&:active?).sort_by(&:name) %>
                          <% if dept_employees.empty? %>
                            <p class="text-xs text-gray-400">배속된 직원이 없습니다.</p>
                          <% else %>
                            <div class="flex flex-wrap gap-2">
                              <% dept_employees.each do |emp| %>
                                <%= link_to employee_path(emp), class: "flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-200 rounded-lg hover:border-primary/50 hover:shadow-sm transition-all" do %>
                                  <div class="w-6 h-6 rounded-full bg-primary/10 flex items-center justify-center text-primary text-xs font-bold flex-shrink-0">
                                    <%= emp.name.first.upcase %>
                                  </div>
                                  <div>
                                    <p class="text-xs font-medium text-gray-900"><%= emp.name %></p>
                                    <% if emp.job_title.present? %>
                                      <p class="text-xs text-gray-400"><%= emp.job_title %></p>
                                    <% end %>
                                  </div>
                                  <%# 비자 상태 배지 %>
                                  <% if emp.active_visa %>
                                    <span class="w-2 h-2 rounded-full flex-shrink-0 <%= emp.visa_expiring_soon? ? 'bg-red-400' : 'bg-green-400' %>"></span>
                                  <% end %>
                                <% end %>
                              <% end %>
                            </div>
                          <% end %>

                          <%# 하위 부서 %>
                          <% sub_depts = dept.sub_departments.select(&:active?).sort_by { |d| [d.sort_order, d.name] } %>
                          <% sub_depts.each do |sub| %>
                            <div class="mt-3 pt-3 border-t border-gray-100">
                              <p class="text-xs font-medium text-gray-500 mb-2">└ <%= sub.name %> (<%= sub.employee_count %>명)</p>
                              <div class="flex flex-wrap gap-2">
                                <% sub.employees.active.by_name.each do |emp| %>
                                  <%= link_to employee_path(emp), class: "flex items-center gap-2 px-3 py-1.5 bg-white border border-gray-200 rounded-lg hover:border-primary/50 text-xs" do %>
                                    <div class="w-5 h-5 rounded-full bg-primary/10 flex items-center justify-center text-primary text-xs font-bold"><%= emp.name.first.upcase %></div>
                                    <%= emp.name %>
                                  <% end %>
                                <% end %>
                              </div>
                            </div>
                          <% end %>

                          <% if current_user.manager? || current_user.admin? %>
                            <div class="mt-2 pt-2 border-t border-gray-100 flex gap-2">
                              <%= link_to new_org_chart_company_department_path(company, parent_id: dept.id),
                                  class: "text-xs text-gray-400 hover:text-primary" do %>+ 하위 부서<% end %>
                            </div>
                          <% end %>
                        </div>
                      </div>
                    <% end %>
                  </div>

                  <%# 부서 추가 버튼 %>
                  <% if current_user.manager? || current_user.admin? %>
                    <div class="px-5 py-3 border-t border-gray-50">
                      <%= link_to new_org_chart_company_department_path(company),
                          class: "inline-flex items-center gap-1 text-xs text-gray-400 hover:text-primary transition-colors" do %>
                        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        부서 추가
                      <% end %>
                    </div>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
