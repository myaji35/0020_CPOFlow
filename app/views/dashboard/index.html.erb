<% content_for :page_title, "Dashboard" %>

<!-- KPI Cards -->
<div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
  <!-- Active Orders -->
  <div class="bg-white rounded-xl border border-gray-200 p-5">
    <div class="flex items-center justify-between mb-3">
      <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Active Orders</span>
      <i class="lni lni-layout text-accent text-xl"></i>
    </div>
    <p class="text-3xl font-bold text-gray-900"><%= @total_active %></p>
    <p class="text-xs text-gray-400 mt-1">In progress</p>
  </div>

  <!-- Overdue -->
  <div class="bg-white rounded-xl border border-gray-200 p-5 <%= @overdue_count > 0 ? 'border-red-200 bg-red-50' : '' %>">
    <div class="flex items-center justify-between mb-3">
      <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Overdue</span>
      <i class="lni lni-warning text-red-500 text-xl"></i>
    </div>
    <p class="text-3xl font-bold <%= @overdue_count > 0 ? 'text-red-600' : 'text-gray-900' %>"><%= @overdue_count %></p>
    <p class="text-xs text-gray-400 mt-1">Past due date</p>
  </div>

  <!-- Urgent (D-7) -->
  <div class="bg-white rounded-xl border border-gray-200 p-5 <%= @urgent_count > 0 ? 'border-orange-200 bg-orange-50' : '' %>">
    <div class="flex items-center justify-between mb-3">
      <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Urgent (D-7)</span>
      <i class="lni lni-alarm text-orange-500 text-xl"></i>
    </div>
    <p class="text-3xl font-bold <%= @urgent_count > 0 ? 'text-orange-600' : 'text-gray-900' %>"><%= @urgent_count %></p>
    <p class="text-xs text-gray-400 mt-1">Due within 7 days</p>
  </div>

  <!-- Delivered this month -->
  <div class="bg-white rounded-xl border border-gray-200 p-5">
    <div class="flex items-center justify-between mb-3">
      <span class="text-xs font-medium text-gray-500 uppercase tracking-wide">Delivered</span>
      <i class="lni lni-checkmark-circle text-green-500 text-xl"></i>
    </div>
    <p class="text-3xl font-bold text-gray-900"><%= @delivered_this_month %></p>
    <p class="text-xs text-gray-400 mt-1">This month</p>
  </div>
</div>

<!-- Kanban Quick Summary -->
<div class="mb-8">
  <h2 class="text-sm font-semibold text-gray-700 uppercase tracking-wide mb-3">Pipeline Overview</h2>
  <div class="flex gap-2 overflow-x-auto pb-2">
    <% Order::KANBAN_COLUMNS.each do |status| %>
      <% count = @kanban_counts[status] || 0 %>
      <%= link_to kanban_path, class: "flex flex-col items-center bg-white border border-gray-200 rounded-lg px-4 py-3 min-w-[90px] hover:border-accent transition-colors" do %>
        <span class="text-xl font-bold text-gray-900"><%= count %></span>
        <span class="text-xs text-gray-500 text-center mt-1"><%= Order::STATUS_LABELS[status] %></span>
      <% end %>
    <% end %>
  </div>
</div>

<%# Google Sheets 동기화 카드 %>
<div class="bg-white rounded-xl border border-gray-200 p-5 mb-6">
  <div class="flex items-center justify-between">
    <div class="flex items-center gap-3">
      <%# Google Sheets 아이콘 %>
      <div class="w-10 h-10 rounded-lg bg-green-50 flex items-center justify-center flex-shrink-0">
        <svg class="w-6 h-6 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M3 9h18M3 15h18M9 3v18"/>
        </svg>
      </div>
      <div>
        <div class="flex items-center gap-2">
          <p class="text-sm font-semibold text-gray-900">Google Sheets 대시보드</p>
          <% if @sheets_mock %>
            <span class="text-xs px-2 py-0.5 rounded-full bg-blue-50 text-blue-600">Mock 모드</span>
          <% end %>
        </div>
        <% if @last_sync %>
          <p class="text-xs text-gray-400 mt-0.5">
            마지막 동기화:
            <span class="<%= @last_sync.failed? ? 'text-red-500' : 'text-gray-500' %>">
              <%= @last_sync.synced_at&.strftime("%Y-%m-%d %H:%M") || "진행중" %>
              · <%= @last_sync.status_label %>
            </span>
            <% if @last_sync.success? || @last_sync.mock? %>
              · 발주 <%= @last_sync.orders_count %>건
              · 현장 <%= @last_sync.projects_count %>건
              · 직원 <%= @last_sync.employees_count %>명
              · 비자 <%= @last_sync.visas_count %>건
            <% end %>
          </p>
        <% else %>
          <p class="text-xs text-gray-400 mt-0.5">아직 동기화 기록이 없습니다.</p>
        <% end %>
      </div>
    </div>
    <%= button_to sync_sheets_path,
        method: :post,
        class: "inline-flex items-center gap-1.5 px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors flex-shrink-0" do %>
      <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="1 4 1 10 7 10"/>
        <path d="M3.51 15a9 9 0 1 0 .49-3.5"/>
      </svg>
      지금 동기화
    <% end %>
  </div>

  <% if @last_sync&.failed? %>
    <div class="mt-3 px-3 py-2 bg-red-50 rounded-lg text-xs text-red-600">
      <span class="font-medium">오류:</span> <%= @last_sync.error_message %>
    </div>
  <% end %>

  <% if @sheets_mock %>
    <div class="mt-3 px-3 py-2 bg-blue-50 rounded-lg text-xs text-blue-600">
      Mock 모드로 동작 중입니다. 실제 Google Sheets에 연동하려면
      <code class="bg-blue-100 px-1 rounded">bin/rails credentials:edit</code>에서
      <code class="bg-blue-100 px-1 rounded">google.service_account</code>와
      <code class="bg-blue-100 px-1 rounded">google.sheets_spreadsheet_id</code>를 등록하세요.
    </div>
  <% end %>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
  <!-- Urgent Orders -->
  <div class="bg-white rounded-xl border border-gray-200">
    <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100">
      <h3 class="font-semibold text-gray-900 text-sm">Urgent Deliveries</h3>
      <%= link_to "View all", kanban_path, class: "text-xs text-accent hover:underline" %>
    </div>
    <div class="divide-y divide-gray-50">
      <% if @urgent_orders.empty? %>
        <div class="px-5 py-8 text-center text-sm text-gray-400">
          <i class="lni lni-checkmark-circle text-3xl block mb-2 text-green-400"></i>
          No urgent orders
        </div>
      <% else %>
        <% @urgent_orders.each do |order| %>
          <%= link_to order_path(order), class: "flex items-center gap-3 px-5 py-3 hover:bg-gray-50 transition-colors" do %>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium text-gray-900 truncate"><%= order.title %></p>
              <p class="text-xs text-gray-500"><%= order.customer_name %></p>
            </div>
            <div class="flex flex-col items-end gap-1">
              <%= due_badge(order) %>
              <%= status_badge(order) %>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <!-- Recent Orders -->
  <div class="bg-white rounded-xl border border-gray-200">
    <div class="flex items-center justify-between px-5 py-4 border-b border-gray-100">
      <h3 class="font-semibold text-gray-900 text-sm">Recent Orders</h3>
      <%= link_to "New Order", new_order_path, class: "text-xs bg-accent text-white px-3 py-1 rounded-lg hover:bg-accent-light transition-colors" %>
    </div>
    <div class="divide-y divide-gray-50">
      <% @recent_orders.each do |order| %>
        <%= link_to order_path(order), class: "flex items-center gap-3 px-5 py-3 hover:bg-gray-50 transition-colors" do %>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-900 truncate"><%= order.title %></p>
            <p class="text-xs text-gray-500"><%= order.customer_name %> &middot; <%= order.created_at.strftime("%b %d") %></p>
          </div>
          <div class="shrink-0">
            <%= status_badge(order) %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
