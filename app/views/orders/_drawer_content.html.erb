<%# ============================================================
    주문 상세 Drawer 콘텐츠 — Drawer / Full page 공용
============================================================ %>
<div class="p-6 space-y-6">

  <%# ── 1. 헤더 메타 정보 ─────────────────────────────────── %>
  <div class="bg-white rounded-xl border border-gray-200 p-5">
    <%# 상태/우선순위/D-day 배지 %>
    <div class="flex flex-wrap items-center gap-2 mb-4">
      <%= status_badge(order) %>
      <%= priority_badge(order) %>
      <% if order.due_date %>
        <%= due_badge(order) %>
      <% end %>
      <% if order.source_email_id.present? %>
        <span class="inline-flex items-center gap-1 text-xs px-2 py-0.5 rounded-full bg-purple-50 text-purple-700">
          <svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          이메일 수신
        </span>
      <% end %>
    </div>

    <%# 주요 정보 그리드 %>
    <dl class="grid grid-cols-2 gap-x-6 gap-y-4 text-sm">
      <div>
        <dt class="text-xs text-gray-400 uppercase tracking-wide mb-1">고객사</dt>
        <dd class="font-medium text-gray-900">
          <% if order.client %>
            <%= link_to order.client.name, client_path(order.client), class: "text-accent hover:underline" %>
          <% else %>
            <%= order.customer_name %>
          <% end %>
        </dd>
      </div>
      <div>
        <dt class="text-xs text-gray-400 uppercase tracking-wide mb-1">마감일</dt>
        <dd class="font-medium text-gray-900"><%= order.due_date&.strftime("%Y년 %m월 %d일") || "—" %></dd>
      </div>
      <% if order.project %>
        <div>
          <dt class="text-xs text-gray-400 uppercase tracking-wide mb-1">프로젝트</dt>
          <dd class="font-medium text-gray-900">
            <%= link_to order.project.name, project_path(order.project), class: "text-accent hover:underline" %>
          </dd>
        </div>
      <% end %>
      <% if order.supplier %>
        <div>
          <dt class="text-xs text-gray-400 uppercase tracking-wide mb-1">공급사</dt>
          <dd class="font-medium text-gray-900">
            <%= link_to order.supplier.name, supplier_path(order.supplier), class: "text-accent hover:underline" %>
          </dd>
        </div>
      <% end %>
      <% if order.item_name.present? %>
        <div>
          <dt class="text-xs text-gray-400 uppercase tracking-wide mb-1">품목</dt>
          <dd class="font-medium text-gray-900"><%= order.item_name %> <%= "× #{order.quantity}" if order.quantity %></dd>
        </div>
      <% end %>
      <% if order.estimated_value.present? %>
        <div>
          <dt class="text-xs text-gray-400 uppercase tracking-wide mb-1">예상 금액</dt>
          <dd class="font-medium text-gray-900">
            <%= number_to_currency(order.estimated_value, unit: order.currency.presence || "$", format: "%u %n") %>
          </dd>
        </div>
      <% end %>
    </dl>

    <%# 설명 %>
    <% if order.description.present? %>
      <div class="mt-4 pt-4 border-t border-gray-100">
        <p class="text-xs text-gray-400 uppercase tracking-wide mb-2">설명</p>
        <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-wrap"><%= order.description %></p>
      </div>
    <% end %>

    <%# 태그 %>
    <% if order.tags_array.any? %>
      <div class="mt-4 flex flex-wrap gap-1.5">
        <% order.tags_array.each do |tag| %>
          <span class="text-xs bg-blue-50 text-blue-600 px-2.5 py-0.5 rounded-full">#<%= tag %></span>
        <% end %>
      </div>
    <% end %>
  </div>

  <%# ── 2. 담당자 + 스테이지 이동 (인라인) ───────────────── %>
  <div class="grid grid-cols-2 gap-4">
    <%# 담당자 %>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">담당자</h4>
      <% if order.assignees.any? %>
        <div class="space-y-2">
          <% order.assignees.each do |u| %>
            <div class="flex items-center gap-2">
              <div class="w-7 h-7 rounded-full bg-primary text-white text-xs flex items-center justify-center font-bold shrink-0">
                <%= u.initials %>
              </div>
              <div class="min-w-0">
                <p class="text-sm font-medium text-gray-900 truncate"><%= u.display_name %></p>
                <p class="text-xs text-gray-400"><%= u.role.capitalize %></p>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-xs text-gray-400">배정된 담당자 없음</p>
      <% end %>
    </div>

    <%# 스테이지 이동 %>
    <div class="bg-white rounded-xl border border-gray-200 p-4">
      <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wide mb-3">스테이지 이동</h4>
      <div class="space-y-1">
        <% Order::KANBAN_COLUMNS.each do |status| %>
          <% is_current = order.status == status %>
          <%= form_with url: move_status_order_path(order), method: :patch do |f| %>
            <%= f.hidden_field :status, value: status %>
            <%= f.submit Order::STATUS_LABELS[status],
                disabled: is_current,
                class: "w-full text-left text-xs py-1.5 px-2.5 rounded-lg cursor-pointer transition-colors #{is_current ? 'bg-accent text-white font-semibold' : 'bg-gray-50 text-gray-700 hover:bg-gray-100 disabled:cursor-default'}" %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <%# ── 3. 이메일 원문 (있을 때만) ───────────────────────── %>
  <% if order.original_email_body.present? %>
    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
      <div class="flex items-center justify-between px-5 py-3 border-b border-gray-100 bg-gray-50">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          <span class="text-xs font-semibold text-gray-700">원본 이메일</span>
        </div>
        <span class="text-xs text-gray-400"><%= order.original_email_from %></span>
      </div>
      <div class="p-5">
        <% if order.original_email_subject.present? %>
          <p class="text-sm font-medium text-gray-900 mb-3"><%= order.original_email_subject %></p>
        <% end %>
        <div class="text-xs text-gray-600 leading-relaxed whitespace-pre-wrap font-mono bg-gray-50 rounded-lg p-4 max-h-48 overflow-y-auto border border-gray-100">
          <%= order.original_email_body %>
        </div>
      </div>
    </div>
  <% end %>

  <%# ── 4. 태스크 체크리스트 ──────────────────────────────── %>
  <div class="bg-white rounded-xl border border-gray-200 p-5">
    <div class="flex items-center justify-between mb-4">
      <h3 class="text-sm font-semibold text-gray-900 flex items-center gap-2">
        <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></polyline></svg>
        태스크
      </h3>
      <% prog = order.task_progress %>
      <span class="text-xs text-gray-400"><%= prog[:done] %>/<%= prog[:total] %> 완료</span>
    </div>

    <%# 진행률 바 %>
    <% if tasks.any? %>
      <% pct = prog[:total] > 0 ? (prog[:done].to_f / prog[:total] * 100).round : 0 %>
      <div class="mb-4">
        <div class="w-full bg-gray-100 rounded-full h-1.5">
          <div class="h-1.5 rounded-full transition-all duration-500 <%= pct == 100 ? 'bg-green-400' : 'bg-accent' %>"
               style="width: <%= pct %>%"></div>
        </div>
      </div>
    <% end %>

    <%# 태스크 목록 %>
    <div class="space-y-1 mb-4" id="task-list-<%= order.id %>">
      <% tasks.each do |task| %>
        <div class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-50 group">
          <%= form_with url: order_task_path(order, task), method: :patch,
              data: { turbo: false } do |f| %>
            <input type="checkbox" name="task[completed]" value="1"
                   <%= task.completed ? "checked" : "" %>
                   onchange="this.form.submit()"
                   class="rounded border-gray-300 text-accent cursor-pointer shrink-0">
            <%= f.hidden_field :completed, value: task.completed ? "0" : "1" %>
          <% end %>
          <div class="flex-1 min-w-0">
            <p class="text-sm <%= task.completed ? 'line-through text-gray-400' : 'text-gray-900' %>">
              <%= task.title %>
            </p>
            <% if task.assignee || task.due_date %>
              <p class="text-xs text-gray-400 mt-0.5">
                <%= task.assignee&.display_name %>
                <% if task.due_date %>· <%= task.due_date.strftime("%m/%d") %><% end %>
              </p>
            <% end %>
          </div>
          <% if task.due_date %>
            <span class="text-xs <%= Date.today > task.due_date ? 'text-red-400' : 'text-gray-400' %>">
              <%= task.due_date.strftime("%m/%d") %>
            </span>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# 태스크 추가 %>
    <%= form_with url: order_tasks_path(order), method: :post,
        data: { turbo: false },
        class: "flex gap-2" do |f| %>
      <%= f.text_field :title, placeholder: "새 태스크 추가...",
          class: "flex-1 px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-accent/30 outline-none" %>
      <%= f.submit "추가",
          class: "bg-gray-100 text-gray-700 text-sm px-3 py-2 rounded-lg hover:bg-gray-200 cursor-pointer whitespace-nowrap" %>
    <% end %>
  </div>

  <%# ── 5. 코멘트 ────────────────────────────────────────── %>
  <div class="bg-white rounded-xl border border-gray-200 p-5">
    <h3 class="text-sm font-semibold text-gray-900 flex items-center gap-2 mb-4">
      <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      코멘트
      <% if comments.any? %>
        <span class="text-xs bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded-full"><%= comments.count %></span>
      <% end %>
    </h3>

    <div class="space-y-4 mb-5">
      <% if comments.any? %>
        <% comments.each do |comment| %>
          <div class="flex gap-3">
            <div class="w-7 h-7 rounded-full bg-primary text-white text-xs flex items-center justify-center font-bold shrink-0 mt-0.5">
              <%= comment.user.initials %>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-1">
                <span class="text-sm font-medium text-gray-900"><%= comment.user.display_name %></span>
                <span class="text-xs text-gray-400"><%= comment.created_at.strftime("%m/%d %H:%M") %></span>
              </div>
              <p class="text-sm text-gray-700 leading-relaxed"><%= comment.body %></p>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="flex items-center justify-center py-6 text-center">
          <div>
            <svg class="w-8 h-8 text-gray-200 mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <p class="text-xs text-gray-400">아직 코멘트가 없습니다</p>
          </div>
        </div>
      <% end %>
    </div>

    <%# 코멘트 작성 %>
    <%= form_with url: order_comments_path(order), method: :post,
        data: { turbo: false },
        class: "flex gap-3" do |f| %>
      <div class="w-7 h-7 rounded-full bg-primary text-white text-xs flex items-center justify-center font-bold shrink-0 mt-0.5">
        <%= current_user.initials %>
      </div>
      <div class="flex-1 space-y-2">
        <%= f.text_area :body, placeholder: "코멘트를 입력하세요...", rows: 2,
            class: "w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-accent/30 outline-none resize-none" %>
        <div class="flex justify-end">
          <%= f.submit "등록",
              class: "bg-accent text-white text-sm px-4 py-1.5 rounded-lg hover:bg-accent/90 cursor-pointer" %>
        </div>
      </div>
    <% end %>
  </div>

  <%# ── 6. 활동 로그 ──────────────────────────────────────── %>
  <% if activities.any? %>
    <div class="bg-white rounded-xl border border-gray-200 p-5">
      <h3 class="text-sm font-semibold text-gray-900 flex items-center gap-2 mb-4">
        <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        활동 기록
      </h3>
      <div class="space-y-3">
        <% activities.first(10).each do |act| %>
          <div class="flex items-start gap-3 text-xs">
            <div class="w-5 h-5 rounded-full bg-gray-100 flex items-center justify-center shrink-0 mt-0.5">
              <svg class="w-3 h-3 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
            </div>
            <div class="flex-1 min-w-0">
              <span class="font-medium text-gray-700"><%= act.user.display_name %></span>
              <span class="text-gray-500"> <%= act.action.humanize.downcase %></span>
              <span class="text-gray-400 block mt-0.5"><%= act.created_at.strftime("%Y/%m/%d %H:%M") %></span>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <%# 하단 여백 %>
  <div class="h-4"></div>
</div>
