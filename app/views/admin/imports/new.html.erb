<%# eCount 데이터 이관 — 파일 업로드 페이지 %>
<div class="max-w-2xl mx-auto py-8 px-4">

  <div class="mb-6">
    <div class="flex items-center gap-2 text-sm text-gray-500 mb-3">
      <%= link_to "데이터 이관", admin_imports_path, class: "hover:text-gray-700" %>
      <span>/</span>
      <span class="text-gray-900">새 이관</span>
    </div>
    <h1 class="text-2xl font-bold text-gray-900">eCountERP 데이터 이관</h1>
    <p class="text-sm text-gray-500 mt-1">CSV(UTF-8/EUC-KR) 또는 XLSX 파일을 업로드하세요</p>
  </div>

  <% if alert %>
    <div class="mb-4 rounded-lg bg-red-50 border border-red-200 px-4 py-3 text-red-800 text-sm"><%= alert %></div>
  <% end %>

  <%= form_with url: admin_imports_path, method: :post, multipart: true, class: "space-y-6" do |f| %>

    <%# Step 1: 이관 유형 선택 %>
    <div class="bg-white rounded-xl border border-gray-200 p-6">
      <h2 class="text-base font-semibold text-gray-900 mb-4">
        <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold inline-flex items-center justify-center mr-2">1</span>
        이관 유형 선택
      </h2>
      <div class="grid grid-cols-3 gap-3">
        <% [
          { value: "products",  label: "품목", desc: "자재/제품 목록", icon: "package", color: "blue" },
          { value: "suppliers", label: "거래처", desc: "공급사/발주처", icon: "users", color: "purple" },
          { value: "orders",    label: "거래이력", desc: "납품 거래 데이터", icon: "file-text", color: "orange" },
        ].each do |opt| %>
          <label class="relative cursor-pointer">
            <input type="radio" name="import_log[import_type]" value="<%= opt[:value] %>"
                   class="sr-only peer" <%= opt[:value] == "products" ? "checked" : "" %>>
            <div class="border-2 border-gray-200 peer-checked:border-blue-500 peer-checked:bg-blue-50 rounded-xl p-4 text-center transition-all hover:border-gray-300">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 mx-auto mb-2 text-gray-400 peer-checked:text-blue-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                <% case opt[:icon]
                   when "package" %>
                  <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                <% when "users" %>
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                <% when "file-text" %>
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/>
                <% end %>
              </svg>
              <p class="text-sm font-semibold text-gray-900"><%= opt[:label] %></p>
              <p class="text-xs text-gray-500 mt-0.5"><%= opt[:desc] %></p>
            </div>
          </label>
        <% end %>
      </div>
    </div>

    <%# Step 2: 파일 업로드 %>
    <div class="bg-white rounded-xl border border-gray-200 p-6">
      <h2 class="text-base font-semibold text-gray-900 mb-4">
        <span class="w-6 h-6 rounded-full bg-blue-600 text-white text-xs font-bold inline-flex items-center justify-center mr-2">2</span>
        파일 업로드
      </h2>

      <%# 드래그 앤 드롭 영역 %>
      <div id="drop-zone"
           class="border-2 border-dashed border-gray-300 hover:border-blue-400 rounded-xl p-8 text-center transition-colors cursor-pointer"
           onclick="document.getElementById('file-input').click()">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 mx-auto text-gray-300 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>
        <p class="text-sm font-medium text-gray-700">파일을 드래그하거나 클릭하여 선택</p>
        <p class="text-xs text-gray-400 mt-1">CSV (UTF-8/EUC-KR), XLSX 지원 · 최대 50MB</p>
        <div id="file-name" class="mt-3 text-sm text-blue-600 font-medium hidden"></div>
      </div>

      <input type="file" id="file-input" name="import_log[import_file]"
             accept=".csv,.xlsx,.xls" class="hidden"
             onchange="showFileName(this)">

      <%# 샘플 파일 다운로드 %>
      <div class="mt-4 p-3 bg-gray-50 rounded-lg">
        <p class="text-xs text-gray-500 font-medium mb-2">샘플 파일 형식 참고:</p>
        <div class="flex gap-3 text-xs text-blue-600">
          <a href="/sample_data/ecount_products_sample.csv" download class="hover:underline">품목 샘플 CSV</a>
          <a href="/sample_data/ecount_suppliers_sample.csv" download class="hover:underline">거래처 샘플 CSV</a>
          <a href="/sample_data/ecount_orders_sample.csv" download class="hover:underline">거래이력 샘플 CSV</a>
        </div>
      </div>
    </div>

    <%# 제출 버튼 %>
    <div class="flex items-center justify-between">
      <%= link_to "취소", admin_imports_path, class: "px-4 py-2 border border-gray-200 text-gray-600 rounded-lg hover:bg-gray-50 text-sm transition-colors" %>
      <%= f.submit "이관 시작", class: "px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm rounded-lg transition-colors cursor-pointer" %>
    </div>

  <% end %>

  <%# 주의사항 %>
  <div class="mt-6 p-4 bg-amber-50 border border-amber-200 rounded-xl text-sm text-amber-800">
    <p class="font-semibold mb-2">이관 전 확인사항</p>
    <ul class="list-disc list-inside space-y-1 text-xs">
      <li>eCountERP에서 내보낸 원본 파일을 사용하세요</li>
      <li>동일한 ecount_code가 있으면 기존 데이터를 덮어씁니다 (Upsert)</li>
      <li>대용량 파일(1,000행+)은 백그라운드에서 처리됩니다</li>
      <li>이관 완료 후 결과 페이지에서 오류 행을 확인하세요</li>
    </ul>
  </div>
</div>

<script>
  function showFileName(input) {
    const nameEl = document.getElementById('file-name');
    if (input.files.length > 0) {
      nameEl.textContent = '선택된 파일: ' + input.files[0].name;
      nameEl.classList.remove('hidden');
    }
  }

  // 드래그 앤 드롭
  const dropZone = document.getElementById('drop-zone');
  const fileInput = document.getElementById('file-input');

  ['dragenter','dragover'].forEach(e => {
    dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.add('border-blue-400','bg-blue-50'); });
  });
  ['dragleave','drop'].forEach(e => {
    dropZone.addEventListener(e, (ev) => { ev.preventDefault(); dropZone.classList.remove('border-blue-400','bg-blue-50'); });
  });
  dropZone.addEventListener('drop', (ev) => {
    ev.preventDefault();
    if (ev.dataTransfer.files.length) {
      fileInput.files = ev.dataTransfer.files;
      showFileName(fileInput);
    }
  });
</script>
