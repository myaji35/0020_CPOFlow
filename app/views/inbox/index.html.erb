<%# Inbox — Gmail-style 3-pane layout %>
<%# Pane 1: Folder list | Pane 2: Email list | Pane 3: Email body %>

<style>
  .inbox-layout {
    display: grid;
    grid-template-columns: 200px 1fr;
    height: calc(100vh - 56px);
    overflow: hidden;
  }
  .inbox-folder-panel {
    border-right: 1px solid #e5e7eb;
    background: #f9fafb;
    overflow-y: auto;
    padding: 16px 12px;
  }
  .inbox-main {
    display: grid;
    grid-template-columns: 340px 1fr;
    overflow: hidden;
  }
  .inbox-list {
    border-right: 1px solid #e5e7eb;
    overflow-y: auto;
  }
  .inbox-body {
    overflow-y: auto;
    background: white;
  }
  .email-item:hover { background: #f0f7ff; }
  .email-item.unread .email-subject { font-weight: 700; color: #111; }
  .email-item.rfq .rfq-badge { display: inline-block; }
  .rfq-badge { display: none; }
</style>

<div class="inbox-layout">

  <%# ===== PANE 1: Folder list ===== %>
  <div class="inbox-folder-panel">
    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-2 mb-2">Inbox</p>
    <nav class="space-y-1">
      <a href="<%= inbox_path %>" class="flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium text-blue-700 bg-blue-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
        All Emails
        <span class="ml-auto text-xs bg-blue-600 text-white rounded-full px-2"><%= @rfq_orders.count %></span>
      </a>
    </nav>

    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wider px-2 mb-2 mt-6">Connected Accounts</p>
    <% accounts = current_user.email_accounts.where(connected: true) %>
    <% if accounts.any? %>
      <% accounts.each do |acc| %>
        <div class="px-3 py-2 rounded-lg text-xs text-gray-600 flex items-center gap-2">
          <span class="w-2 h-2 rounded-full bg-green-500 flex-shrink-0"></span>
          <span class="truncate"><%= acc.email %></span>
        </div>
      <% end %>
    <% else %>
      <div class="px-3 py-2 text-xs text-gray-400">
        No accounts connected.
        <%= link_to "Connect Gmail →", settings_root_path, class: "text-blue-500 hover:underline" %>
      </div>
    <% end %>
  </div>

  <%# ===== PANE 2 + 3 ===== %>
  <div class="inbox-main">

    <%# ===== PANE 2: Email list ===== %>
    <div class="inbox-list">
      <%# Toolbar %>
      <div class="sticky top-0 z-10 bg-white border-b border-gray-100 px-4 py-3 flex items-center justify-between">
        <span class="text-sm font-semibold text-gray-700">RFQ Emails</span>
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-400"><%= @all_orders.count %> messages</span>
          <%# Manual sync button %>
          <% if current_user.email_accounts.where(connected: true).any? %>
            <button onclick="triggerSync()" class="text-xs px-3 py-1.5 border border-gray-200 rounded-lg hover:bg-gray-50 text-gray-600 flex items-center gap-1">
              <svg id="sync-icon" xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
              Sync
            </button>
          <% end %>
        </div>
      </div>

      <%# Email list items %>
      <% if @all_orders.any? %>
        <ul id="email-list" class="divide-y divide-gray-100">
          <% @all_orders.each do |order| %>
            <li class="email-item cursor-pointer px-4 py-3 hover:bg-blue-50 transition-colors <%= order.source_email_id.present? ? 'rfq' : '' %>"
                onclick="showEmail(<%= order.id %>)"
                data-order-id="<%= order.id %>">
              <div class="flex items-center gap-2 mb-1">
                <%# RFQ badge %>
                <span class="rfq-badge text-xs px-1.5 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">RFQ</span>
                <%# Priority indicator %>
                <% case order.priority
                   when "urgent" %>
                  <span class="w-2 h-2 rounded-full bg-red-500 flex-shrink-0"></span>
                <% when "high" %>
                  <span class="w-2 h-2 rounded-full bg-orange-400 flex-shrink-0"></span>
                <% end %>
                <%# Date %>
                <span class="ml-auto text-xs text-gray-400 flex-shrink-0">
                  <%= order.created_at.strftime("%b %d") %>
                </span>
              </div>
              <p class="email-subject text-sm text-gray-900 truncate"><%= order.original_email_subject.presence || order.title %></p>
              <p class="text-xs text-gray-500 truncate mt-0.5"><%= order.original_email_from.presence || order.customer_name %></p>
              <p class="text-xs text-gray-400 truncate mt-0.5"><%= order.description.presence&.truncate(80) %></p>
            </li>
          <% end %>
        </ul>
      <% else %>
        <div class="flex flex-col items-center justify-center py-20 text-center px-6">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-gray-200 mb-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>
          <p class="text-sm text-gray-400">No emails yet</p>
          <p class="text-xs text-gray-300 mt-1">Connect a Gmail account to start importing RFQs</p>
          <%= link_to "Go to Settings →", settings_root_path, class: "mt-4 text-sm text-blue-600 hover:underline" %>
        </div>
      <% end %>
    </div>

    <%# ===== PANE 3: Email body ===== %>
    <div class="inbox-body" id="email-body-pane">
      <%# Default empty state %>
      <div id="email-empty-state" class="flex flex-col items-center justify-center h-full text-center px-8">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-14 h-14 text-gray-200 mb-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        <p class="text-gray-400 text-sm">Select an email to read</p>
      </div>

      <%# Email detail (rendered per order) %>
      <% if @rfq_orders.any? %>
        <% @rfq_orders.each do |order| %>
          <div id="email-detail-<%= order.id %>" class="email-detail hidden p-6">

            <%# Email header %>
            <div class="border-b border-gray-100 pb-5 mb-5">
              <div class="flex items-start justify-between gap-4">
                <div>
                  <h2 class="text-lg font-bold text-gray-900"><%= order.original_email_subject.presence || order.title %></h2>
                  <p class="text-sm text-gray-500 mt-1">
                    From: <strong><%= order.original_email_from.presence || order.customer_name %></strong>
                    &nbsp;·&nbsp; <%= order.created_at.strftime("%A, %B %d, %Y at %H:%M") %>
                  </p>
                </div>
                <%# Action buttons %>
                <div class="flex items-center gap-2 flex-shrink-0">
                  <span class="text-xs px-2 py-1 rounded-full <%= order.status == 'inbox' ? 'bg-gray-100 text-gray-600' : 'bg-green-100 text-green-700' %>">
                    <%= order.status == 'inbox' ? 'In Inbox' : Order::STATUS_LABELS[order.status] %>
                  </span>
                  <% if order.status.to_s == "inbox" %>
                    <%= button_to convert_email_to_order_path(order),
                        method: :post,
                        data: { turbo_confirm: "Move to Kanban board?" },
                        class: "flex items-center gap-1.5 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                      Add to Kanban
                    <% end %>
                  <% else %>
                    <%= link_to "View in Kanban", order_path(order), class: "flex items-center gap-1.5 px-3 py-2 border border-gray-200 text-gray-600 hover:bg-gray-50 text-sm font-medium rounded-lg transition-colors" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
                      View Order
                    <% end %>
                  <% end %>
                </div>
              </div>

              <%# RFQ metadata chips %>
              <div class="flex flex-wrap gap-2 mt-4">
                <% if order.due_date %>
                  <span class="inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-full bg-orange-50 text-orange-700 border border-orange-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                    Due <%= order.due_date.strftime("%d %b %Y") %>
                  </span>
                <% end %>
                <% if order.item_name.present? %>
                  <span class="inline-flex items-center gap-1 text-xs px-2.5 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/></svg>
                    <%= order.item_name %>
                  </span>
                <% end %>
                <% if order.tags.present? %>
                  <% order.tags.split(",").each do |tag| %>
                    <span class="text-xs px-2.5 py-1 rounded-full bg-gray-100 text-gray-600"><%= tag.strip %></span>
                  <% end %>
                <% end %>
              </div>
            </div>

            <%# Email body %>
            <div class="prose prose-sm max-w-none text-gray-700 text-sm leading-relaxed whitespace-pre-wrap font-mono bg-gray-50 rounded-lg p-4 border border-gray-100 max-h-96 overflow-y-auto">
<%= order.original_email_body.presence || order.description %>
            </div>

            <%# Quick reply link to full order %>
            <div class="mt-6 pt-4 border-t border-gray-100 flex items-center justify-between">
              <p class="text-xs text-gray-400">Order #<%= order.id %> — Created <%= time_ago_in_words(order.created_at) %> ago</p>
              <%= link_to "Open Full Order →", order_path(order), class: "text-sm text-blue-600 hover:underline" %>
            </div>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>

<script>
  function showEmail(orderId) {
    // Hide all email details
    document.querySelectorAll('.email-detail').forEach(el => el.classList.add('hidden'));
    document.getElementById('email-empty-state')?.classList.add('hidden');

    // Show selected email
    const detail = document.getElementById('email-detail-' + orderId);
    if (detail) {
      detail.classList.remove('hidden');
    } else {
      // Fallback: navigate to the order if detail not in DOM
      window.location.href = '/inbox/' + orderId;
    }

    // Highlight selected item in list
    document.querySelectorAll('.email-item').forEach(el => el.classList.remove('bg-blue-50'));
    const item = document.querySelector('[data-order-id="' + orderId + '"]');
    if (item) item.classList.add('bg-blue-50');
  }

  // Auto-select first email on load
  const firstItem = document.querySelector('.email-item');
  if (firstItem) {
    const firstId = firstItem.getAttribute('data-order-id');
    if (firstId) showEmail(parseInt(firstId));
  }

  function triggerSync() {
    const icon = document.getElementById('sync-icon');
    icon.style.animation = 'spin 1s linear infinite';
    fetch('/inbox/sync', { method: 'POST', headers: { 'X-CSRF-Token': document.querySelector('meta[name=csrf-token]')?.content } })
      .then(() => { setTimeout(() => { icon.style.animation = ''; window.location.reload(); }, 2000); })
      .catch(() => { icon.style.animation = ''; });
  }
</script>

<style>
  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
